apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-toolkit
  namespace: ai-toolkit
  labels:
    app: ai-toolkit
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-toolkit
  template:
    metadata:
      labels:
        app: ai-toolkit
    spec:
      # GPU 支持
      # 如果集群使用 NVIDIA GPU Runtime Class，取消下面的注释
      # runtimeClassName: nvidia
      # 或者使用 nodeSelector 选择 GPU 节点
      # nodeSelector:
      #   accelerator: nvidia-tesla-k80  # 根据你的 GPU 节点标签调整
      containers:
      - name: ai-toolkit
        image: ostris/aitoolkit:latest
        imagePullPolicy: Always
        # 在启动前创建数据库文件的符号链接
        command: ['/bin/bash', '-c']
        args:
          - |
            # 如果目标路径已存在且不是符号链接，先备份或删除
            if [ -f /app/ai-toolkit/aitk_db.db ] && [ ! -L /app/ai-toolkit/aitk_db.db ]; then
              echo "警告: /app/ai-toolkit/aitk_db.db 已存在，移动到备份位置"
              mv /app/ai-toolkit/aitk_db.db /app/ai-toolkit/aitk_db.db.backup || true
            fi
            # 创建数据库文件的符号链接（如果不存在）
            if [ ! -L /app/ai-toolkit/aitk_db.db ]; then
              ln -s /app/ai-toolkit/data/aitk_db.db /app/ai-toolkit/aitk_db.db
              echo "已创建数据库文件符号链接: /app/ai-toolkit/aitk_db.db -> /app/ai-toolkit/data/aitk_db.db"
            fi
            # 执行原始启动脚本
            exec /start.sh
        ports:
        - name: http
          containerPort: 8675
          protocol: TCP
        env:
        - name: AI_TOOLKIT_AUTH
          valueFrom:
            secretKeyRef:
              name: ai-toolkit-secret
              key: auth-token
        - name: NODE_ENV
          value: "production"
        - name: TZ
          value: "UTC"
        resources:
          limits:
            # 根据实际 GPU 数量调整，如果需要使用所有 GPU，设置为节点上的 GPU 数量
            nvidia.com/gpu: 1  # 或者设置为具体数量，如 2, 4, 8 等
          requests:
            nvidia.com/gpu: 1
        volumeMounts:
        # HuggingFace 缓存
        - name: storage
          mountPath: /root/.cache/huggingface/hub
          subPath: huggingface-cache
        # 数据库文件 - 挂载 data 目录，数据库文件在 data/aitk_db.db
        # 应用期望路径是 /app/ai-toolkit/aitk_db.db，需要通过启动脚本创建符号链接
        - name: storage
          mountPath: /app/ai-toolkit/data
          subPath: data
        # 数据集目录
        - name: storage
          mountPath: /app/ai-toolkit/datasets
          subPath: datasets
        # 输出目录
        - name: storage
          mountPath: /app/ai-toolkit/output
          subPath: output
        # 配置目录
        - name: storage
          mountPath: /app/ai-toolkit/config
          subPath: config
        # 共享内存 60GB
        - name: shm
          mountPath: /dev/shm
      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: ai-toolkit-storage
      - name: shm
        emptyDir:
          medium: Memory
          sizeLimit: 60Gi
      restartPolicy: Always
